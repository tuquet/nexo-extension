/**
 * Prompt Form Component - Dual Mode Editor
 * Create/edit prompts using JSON textarea OR visual UI editor
 */

import {
  Alert,
  AlertDescription,
  Button,
  Dialog,
  DialogContent,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  Input,
  Label,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
  Textarea,
} from '@extension/ui';
import { AlertCircle, FileJson, Pencil } from 'lucide-react';
import { useEffect, useState } from 'react';
import type { PromptRecord } from '@src/db';

interface PromptFormProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSubmit: (data: PromptFormData) => void;
  initialData?: PromptRecord;
  mode: 'create' | 'edit';
}

interface PromptFormData {
  title: string;
  category: PromptRecord['category'];
  prompt: string;
  description?: string;
  tags?: string[];
  icon?: string;
  systemInstruction?: string;
  outputFormat?: string;
  modelSettings?: {
    preferredModel?: string;
    temperature?: number;
    topP?: number;
    topK?: number;
    maxOutputTokens?: number;
  };
  preprocessing?: {
    enableVariables?: boolean;
    variableDefinitions?: string;
    injectContext?: boolean;
  };
  postprocessing?: {
    steps?: Array<'trim' | 'remove-quotes' | 'parse-json' | 'extract-field'>;
  };
}

const DEFAULT_PROMPT_TEMPLATE = {
  title: 'New Prompt',
  category: 'general',
  prompt: 'Your prompt template here...',
  description: '',
  tags: [],
  icon: 'ðŸ’¡',
  systemInstruction: '',
  outputFormat: 'json-structured',
  modelSettings: {
    preferredModel: 'gemini-2.5-flash',
    temperature: 1.0,
    topP: 0.95,
    topK: 40,
    maxOutputTokens: 8192,
  },
  preprocessing: {
    enableVariables: false,
    variableDefinitions: '',
    injectContext: false,
  },
  postprocessing: {
    steps: ['trim', 'parse-json'],
  },
};

const PromptForm = ({ open, onOpenChange, onSubmit, initialData, mode }: PromptFormProps) => {
  const [jsonInput, setJsonInput] = useState('');
  const [jsonError, setJsonError] = useState<string | null>(null);
  const [editMode, setEditMode] = useState<'ui' | 'json'>('ui');

  useEffect(() => {
    if (open) {
      // Convert initialData or default template to formatted JSON
      const dataToEdit = initialData || DEFAULT_PROMPT_TEMPLATE;
      // Remove id, createdAt, updatedAt from display
      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const { id, createdAt, updatedAt, ...editableData } = dataToEdit as PromptRecord;
      setJsonInput(JSON.stringify(editableData, null, 2));
      setJsonError(null);
    }
  }, [initialData, open]);

  const handleJsonChange = (value: string) => {
    setJsonInput(value);
    setJsonError(null);
  };

  const handleUISubmit = (data: Partial<PromptRecord>) => {
    onSubmit(data as PromptFormData);
    onOpenChange(false);
  };

  const handleJsonSubmit = () => {
    try {
      const parsed = JSON.parse(jsonInput) as PromptFormData;

      // Validate required fields
      if (!parsed.title || !parsed.title.trim()) {
        setJsonError('Field "title" is required');
        return;
      }
      if (!parsed.category) {
        setJsonError('Field "category" is required');
        return;
      }
      if (!parsed.prompt || !parsed.prompt.trim()) {
        setJsonError('Field "prompt" is required');
        return;
      }

      // Valid categories
      const validCategories = ['script-generation', 'image-generation', 'video-generation', 'character-dev', 'general'];
      if (!validCategories.includes(parsed.category)) {
        setJsonError(`Invalid category. Must be one of: ${validCategories.join(', ')}`);
        return;
      }

      onSubmit(parsed);
      onOpenChange(false);
    } catch (error) {
      setJsonError(error instanceof Error ? error.message : 'Invalid JSON format');
    }
  };

  const dataToEdit = initialData || (DEFAULT_PROMPT_TEMPLATE as unknown as PromptRecord);

  // Store form data for visual editor
  const [formData, setFormData] = useState<Partial<PromptRecord>>(dataToEdit);

  // Simple inline visual editor (for now, basic fields)
  const renderUIEditor = () => (
    <div className="space-y-6">
      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="title">Title</Label>
          <Input
            id="title"
            value={formData.title || ''}
            onChange={e => setFormData({ ...formData, title: e.target.value })}
            placeholder="Enter prompt title"
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="category">Category</Label>
          <Select
            value={formData.category || 'general'}
            onValueChange={value => setFormData({ ...formData, category: value })}>
            <SelectTrigger id="category">
              <SelectValue placeholder="Select category" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="script-generation">Script Generation</SelectItem>
              <SelectItem value="image-generation">Image Generation</SelectItem>
              <SelectItem value="video-generation">Video Generation</SelectItem>
              <SelectItem value="character-dev">Character Development</SelectItem>
              <SelectItem value="general">General</SelectItem>
            </SelectContent>
          </Select>
        </div>

        <div className="space-y-2">
          <Label htmlFor="description">Description</Label>
          <Textarea
            id="description"
            value={formData.description || ''}
            onChange={e => setFormData({ ...formData, description: e.target.value })}
            placeholder="Enter description"
            rows={3}
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="icon">Icon</Label>
          <Input
            id="icon"
            value={formData.icon || 'ðŸ“'}
            onChange={e => setFormData({ ...formData, icon: e.target.value })}
            placeholder="Enter icon emoji"
            maxLength={2}
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="systemInstruction">System Instruction</Label>
          <Textarea
            id="systemInstruction"
            value={formData.systemInstruction || ''}
            onChange={e => setFormData({ ...formData, systemInstruction: e.target.value })}
            placeholder="Enter system instruction"
            rows={5}
          />
        </div>

        <Alert>
          <AlertDescription className="">
            <strong>Note:</strong> For advanced configuration (variables, model settings), use JSON Editor tab or the
            full PromptEditor for complete control.
          </AlertDescription>
        </Alert>
      </div>
    </div>
  );

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-h-[90vh] max-w-5xl overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {mode === 'create' ? 'Create New Prompt' : `Edit Prompt: ${initialData?.title || ''}`}
          </DialogTitle>
        </DialogHeader>

        <Tabs value={editMode} onValueChange={value => setEditMode(value as 'ui' | 'json')}>
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="ui" className="gap-2">
              <Pencil className="size-4" />
              Visual Editor
            </TabsTrigger>
            <TabsTrigger value="json" className="gap-2">
              <FileJson className="size-4" />
              JSON Editor
            </TabsTrigger>
          </TabsList>

          <TabsContent value="ui" className="mt-4 space-y-4">
            {renderUIEditor()}
          </TabsContent>

          <TabsContent value="json" className="mt-4 space-y-4">
            {/* JSON Editor */}
            <div className="grid gap-2">
              <Label htmlFor="jsonEditor">Prompt Configuration (JSON)</Label>
              <Textarea
                id="jsonEditor"
                placeholder="Paste or edit JSON configuration..."
                value={jsonInput}
                onChange={e => handleJsonChange(e.target.value)}
                rows={20}
                className="font-mono text-sm"
              />
              <p className="text-muted-foreground ">
                Edit the JSON object above. Required fields: <code className="bg-muted rounded px-1">title</code>,{' '}
                <code className="bg-muted rounded px-1">category</code>,{' '}
                <code className="bg-muted rounded px-1">prompt</code>
              </p>
            </div>

            {/* Error Alert */}
            {jsonError && (
              <Alert variant="destructive">
                <AlertCircle className="size-4" />
                <AlertDescription>{jsonError}</AlertDescription>
              </Alert>
            )}

            {/* Help Text */}
            <Alert>
              <AlertDescription className="">
                <strong>Valid categories:</strong> script-generation, image-generation, video-generation, character-dev,
                general
                <br />
                <strong>Example:</strong> See default template when creating new prompt
              </AlertDescription>
            </Alert>

            <DialogFooter className="mt-4">
              <Button variant="outline" onClick={() => onOpenChange(false)}>
                Cancel
              </Button>
              <Button onClick={handleJsonSubmit}>{mode === 'create' ? 'Create Prompt' : 'Save Changes'}</Button>
            </DialogFooter>
          </TabsContent>
        </Tabs>
      </DialogContent>
    </Dialog>
  );
};

export { PromptForm };
export type { PromptFormData };
